<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loopd | Infinite Sounds</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Space Grotesk', monospace; 
            background: #000; 
            color: #fff; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
        }

        /* Sidebar */
        .sidebar {
            width: 220px;
            background: #000;
            border-right: 2px solid #fff;
            display: flex;
            flex-direction: column;
            padding: 40px 20px;
        }

        .logo { 
            font-size: 32px; 
            font-weight: 700; 
            letter-spacing: -2px; 
            margin-bottom: 60px;
            text-transform: uppercase;
        }

        .nav-item {
            padding: 16px 0;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border-bottom: 1px solid #222;
            transition: all 0.2s;
        }
        .nav-item:hover { 
            background: #fff; 
            color: #000; 
            padding-left: 10px;
        }
        .nav-item.active { 
            background: #fff; 
            color: #000; 
            padding-left: 10px;
        }

        .upload-btn {
            margin-top: auto;
            background: #fff;
            color: #000;
            padding: 18px;
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            border: 2px solid #fff;
            transition: all 0.2s;
        }
        .upload-btn:hover { 
            background: #000; 
            color: #fff; 
        }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; }
        
        /* Top Bar */
        .top-bar {
            height: 80px;
            border-bottom: 2px solid #fff;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 40px;
            background: #000;
        }

        .search-box {
            background: #000;
            border: 2px solid #fff;
            padding: 12px 20px;
            width: 400px;
            display: flex; 
            align-items: center; 
            gap: 15px;
        }
        .search-box input { 
            background: transparent; 
            border: none; 
            color: #fff; 
            width: 100%; 
            outline: none;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .auth-widget { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            font-size: 12px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .credits-badge { 
            background: #fff; 
            color: #000; 
            padding: 8px 16px; 
            border: 2px solid #fff;
        }
        .auth-btn {
            background: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 8px 16px;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .auth-btn:hover {
            background: #fff;
            color: #000;
        }
        
        /* Content Area */
        .content-scroll { 
            flex: 1; 
            overflow-y: auto; 
            padding: 40px; 
            padding-bottom: 120px; 
        }

        .section-header { 
            margin-bottom: 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 2px solid #fff;
        }
        .section-title { 
            font-size: 28px; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -1px;
        }

        /* Sample Table */
        .sample-header {
            display: grid;
            grid-template-columns: 60px 4fr 1fr 1fr 120px;
            padding: 16px 0;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #fff;
        }

        .sample-row {
            display: grid;
            grid-template-columns: 60px 4fr 1fr 1fr 120px;
            padding: 20px 0;
            align-items: center;
            font-size: 14px;
            border-bottom: 1px solid #333;
            transition: all 0.1s;
        }
        .sample-row:hover { 
            background: #fff; 
            color: #000;
            padding-left: 20px;
        }
        .sample-row.playing { 
            background: #fff; 
            color: #000;
            padding-left: 20px;
        }
        
        .play-btn { 
            width: 36px; 
            height: 36px; 
            background: #000; 
            border: 2px solid #fff;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #fff; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .play-btn:hover { 
            background: #fff; 
            color: #000; 
        }
        .sample-row.playing .play-btn { 
            background: #000; 
            color: #fff; 
        }
        .sample-row:hover .play-btn {
            border-color: #000;
        }

        .sample-name { 
            font-weight: 700; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .row-actions { 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
        }
        .action-icon { 
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        .action-icon:hover { 
            transform: scale(1.2);
        }

        /* Modal */
        .modal-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; 
            align-items: center; 
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #000;
            border: 3px solid #fff;
            padding: 60px 40px;
            width: 450px;
        }
        .modal h2 {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: -1px;
            margin-bottom: 30px;
        }
        .modal input {
            width: 100%; 
            padding: 16px; 
            margin-bottom: 15px;
            background: #000; 
            border: 2px solid #fff; 
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .modal input::placeholder {
            color: #666;
        }
        .modal button {
            width: 100%; 
            padding: 18px; 
            background: #fff;
            color: #000; 
            font-weight: 700; 
            border: 2px solid #fff;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .modal button:hover {
            background: #000;
            color: #fff;
        }
        .modal-text {
            margin-top: 20px;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .modal-close {
            cursor: pointer;
            text-align: center;
            margin-top: 15px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #fff;
        }
        .modal-close:hover {
            text-decoration: underline;
        }

        /* Upload Modal Specific */
        #upload-modal .modal { width: 550px; }
        .file-drop {
            border: 2px dashed #fff; 
            padding: 60px 40px; 
            text-align: center;
            margin: 20px 0; 
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-drop:hover { 
            background: #fff;
            color: #000;
        }
        .input-row {
            display: flex;
            gap: 15px;
        }

        /* Bottom Player */
        .player {
            position: fixed; 
            bottom: 0; 
            left: 220px; 
            right: 0;
            height: 90px; 
            background: #000; 
            border-top: 2px solid #fff;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 40px; 
            z-index: 100;
        }
        .player-info {
            width: 250px;
        }
        .player-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        .player-meta {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .main-play-btn {
            width: 50px;
            height: 50px;
            background: #fff;
            color: #000;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .main-play-btn:hover {
            background: #000;
            color: #fff;
        }
        .waveform {
            flex: 1;
            height: 40px;
            margin: 0 40px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .download-btn {
            background: #fff;
            color: #000;
            padding: 12px 24px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 2px solid #fff;
            cursor: pointer;
            transition: all 0.2s;
        }
        .download-btn:hover {
            background: #000;
            color: #fff;
        }

        /* Utilities */
        .hidden { display: none !important; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #fff; border: 1px solid #000; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">LOOPD</div>
        
        <div class="nav-item active" onclick="switchTab('browse')">
            Browse
        </div>
        <div class="nav-item" onclick="switchTab('likes')">
            Liked
        </div>
        <div class="nav-item" onclick="switchTab('downloads')">
            Downloads
        </div>

        <div class="upload-btn" onclick="openUploadModal()">
            + Upload
        </div>
    </nav>

    <main class="main">
        <div class="top-bar">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" placeholder="Search">
            </div>
            
            <div class="auth-widget" id="auth-ui">
                <button class="auth-btn" onclick="showAuthModal()">Log In</button>
            </div>
        </div>

        <div class="content-scroll">
            <div class="section-header">
                <h2 class="section-title" id="page-title">Browse Library</h2>
                <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">
                    Sort: <span style="font-weight: 700;">Newest</span>
                </div>
            </div>

            <div class="sample-header">
                <div></div>
                <div>Name</div>
                <div>BPM</div>
                <div>Key</div>
                <div style="text-align: right">Actions</div>
            </div>

            <div id="sample-list">
                <div style="padding:60px 0; text-align:center; color: #333; text-transform: uppercase; letter-spacing: 2px; font-size: 11px;">
                    Loading samples...
                </div>
            </div>
        </div>
    </main>

    <div class="player">
        <div class="player-info">
            <div class="player-title" id="player-title">No Track</div>
            <div class="player-meta" id="player-author">—</div>
        </div>
        
        <button class="main-play-btn" onclick="toggleMainPlay()">
            <i class="fa-solid fa-play" id="main-play-icon"></i>
        </button>

        <div class="waveform">Waveform</div>

        <button class="download-btn" onclick="downloadCurrent()">
            Download (1)
        </button>

        <audio id="global-audio"></audio>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay hidden" id="auth-modal">
        <div class="modal">
            <h2>Account</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="handleAuth()">Sign In / Sign Up</button>
            <p class="modal-text">
                New users receive 5 free credits
            </p>
            <p class="modal-close" onclick="closeModals()">Close</p>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal-overlay hidden" id="upload-modal">
        <div class="modal">
            <h2>Upload Sample</h2>
            <input type="text" id="up-name" placeholder="Sample Name">
            <div class="input-row">
                <input type="number" id="up-bpm" placeholder="BPM">
                <input type="text" id="up-key" placeholder="Key">
            </div>
            
            <input type="file" id="up-file" class="hidden" accept=".wav,.mp3">
            <div class="file-drop" onclick="document.getElementById('up-file').click()">
                <i class="fa-solid fa-file-audio" style="font-size: 40px; margin-bottom: 15px;"></i><br>
                <span id="file-name-display" style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">
                    Click to select file
                </span>
            </div>

            <button onclick="uploadSample()">Upload</button>
            <p class="modal-close" onclick="closeModals()">Cancel</p>
        </div>
    </div>


    <script type="module">
        // -----------------------------------------------------
        // 1. CONFIGURATION
        // -----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, updateDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDHtQ80PZrnbx-7avGEei6-hkKASKKufFw",
          authDomain: "loopd-app.firebaseapp.com",
          projectId: "loopd-app",
          storageBucket: "loopd-app.firebasestorage.app",
          messagingSenderId: "380753853039",
          appId: "1:380753853039:web:f52d0618cb9a027d7f6b9a",
          measurementId: "G-9FCMND5KL2"
        };

        const supabaseUrl = 'https://kzzjzmmdtoryruackdei.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6emp6bW1kdG9yeXJ1YWNrZGVpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3NTQ3OTksImV4cCI6MjA4NDMzMDc5OX0.mx7UAyVr0QuyiWVwOhNDeX81kjVLlL9PQNtq9_qGAkc'; 

        // Initialize Services
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // -----------------------------------------------------
        // 2. APP STATE
        // -----------------------------------------------------
        let currentUser = null;
        let userCredits = 0;
        let currentTrack = null;
        let allSamples = [];
        const audio = document.getElementById('global-audio');

        // -----------------------------------------------------
        // 3. AUTHENTICATION LOGIC
        // -----------------------------------------------------
        window.showAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
        window.closeModals = () => document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden'));

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                if(error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    try {
                        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
                        await setDoc(doc(db, "users", userCred.user.uid), {
                            email: email,
                            credits: 5,
                            downloads: [],
                            likes: []
                        });
                        alert("Account created! You have 5 Free Credits.");
                    } catch (signupErr) {
                        alert("Error: " + signupErr.message);
                    }
                } else {
                    alert("Error: " + error.message);
                }
            }
            closeModals();
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            const ui = document.getElementById('auth-ui');
            
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userCredits = userDoc.data().credits;
                    ui.innerHTML = `
                        <div class="credits-badge">${userCredits} Credits</div>
                        <div style="cursor:pointer; text-transform: uppercase; letter-spacing: 1px;" onclick="logout()">Sign Out</div>
                    `;
                }
            } else {
                ui.innerHTML = `<button class="auth-btn" onclick="showAuthModal()">Log In</button>`;
                userCredits = 0;
            }
        });

        window.logout = () => signOut(auth);

        // -----------------------------------------------------
        // 4. SUPABASE UPLOAD & FIRESTORE SAVE
        // -----------------------------------------------------
        window.openUploadModal = () => {
            if(!currentUser) return alert("Please log in to upload.");
            document.getElementById('upload-modal').classList.remove('hidden');
        };

        document.getElementById('up-file').addEventListener('change', function() {
            if(this.files[0]) document.getElementById('file-name-display').innerText = this.files[0].name;
        });

        window.uploadSample = async () => {
            const file = document.getElementById('up-file').files[0];
            const name = document.getElementById('up-name').value;
            const bpm = document.getElementById('up-bpm').value;
            const key = document.getElementById('up-key').value;

            if(!file || !name) return alert("Please fill all fields");

            const fileName = `${Date.now()}_${file.name}`;
            const { data, error } = await supabase.storage.from('samples').upload(fileName, file);

            if(error) return alert("Upload failed: " + error.message);

            const { data: { publicUrl } } = supabase.storage.from('samples').getPublicUrl(fileName);

            await addDoc(collection(db, "samples"), {
                name: name,
                bpm: bpm,
                key: key,
                url: publicUrl,
                uploaderId: currentUser.uid,
                createdAt: new Date()
            });

            alert("Sample Uploaded Successfully!");
            closeModals();
            loadSamples();
        };

        // -----------------------------------------------------
        // 5. DISPLAY SAMPLES & PLAYBACK
        // -----------------------------------------------------
        async function loadSamples(filter = 'all') {
            const list = document.getElementById('sample-list');
            list.innerHTML = '<div style="padding:60px 0; text-align:center; color:#333; text-transform: uppercase; letter-spacing: 2px; font-size: 11px;">Refreshing...</div>';

            let q = query(collection(db, "samples"));
            
            const snapshot = await getDocs(q);
            allSamples = [];
            snapshot.forEach(doc => allSamples.push({ id: doc.id, ...doc.data() }));

            list.innerHTML = '';
            if(allSamples.length === 0) {
                list.innerHTML = '<div style="padding:60px 0; text-align:center; text-transform: uppercase; letter-spacing: 2px; font-size: 11px;">No samples found</div>';
                return;
            }

            allSamples.forEach(s => {
                const div = document.createElement('div');
                div.className = 'sample-row';
                div.setAttribute('data-id', s.id);
                div.innerHTML = `
                    <div class="play-btn" onclick="playTrack('${s.id}')">
                        <i class="fa-solid fa-play" id="icon-${s.id}"></i>
                    </div>
                    <div class="sample-name">${s.name}</div>
                    <div>${s.bpm}</div>
                    <div>${s.key}</div>
                    <div class="row-actions">
                        <i class="fa-regular fa-heart action-icon"></i>
                        <i class="fa-solid fa-download action-icon" onclick="downloadSample('${s.id}')"></i>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        window.playTrack = (id) => {
            const sample = allSamples.find(s => s.id === id);
            if(!sample) return;

            document.querySelectorAll('.sample-row').forEach(r => r.classList.remove('playing'));
            document.querySelectorAll('.fa-pause').forEach(i => i.classList.replace('fa-pause', 'fa-play'));

            if(currentTrack && currentTrack.id === id && !audio.paused) {
                audio.pause();
                return;
            }

            currentTrack = sample;
            audio.src = sample.url;
            audio.play();

            const row = document.querySelector(`.sample-row[data-id="${id}"]`);
            if(row) row.classList.add('playing');
            
            const icon = document.getElementById(`icon-${id}`);
            if(icon) {
                icon.classList.remove('fa-play');
                icon.classList.add('fa-pause');
            }

            document.getElementById('player-title').innerText = sample.name;
            document.getElementById('player-author').innerText = `${sample.bpm} BPM — ${sample.key}`;
            document.getElementById('main-play-icon').classList.replace('fa-play', 'fa-pause');
        };

        window.toggleMainPlay = () => {
            if (audio.paused && currentTrack) {
                audio.play();
                document.getElementById('main-play-icon').classList.replace('fa-play', 'fa-pause');
            } else {
                audio.pause();
                document.getElementById('main-play-icon').classList.replace('fa-pause', 'fa-play');
            }
        };

        // -----------------------------------------------------
        // 6. DOWNLOADING & CREDITS
        // -----------------------------------------------------
        window.downloadSample = async (id) => {
            let sampleId = id || (currentTrack ? currentTrack.id : null);
            if (!sampleId) return;
            
            if(!currentUser) return alert("Log in to download.");
            if(userCredits < 1) return alert("Not enough credits!");

            const sample = allSamples.find(s => s.id === sampleId);

            const userRef = doc(db, "users", currentUser.uid);
            await updateDoc(userRef, {
                credits: userCredits - 1
            });
            
            userCredits--;
            document.querySelector('.credits-badge').innerText = `${userCredits} Credits`;

            const a = document.createElement('a');
            a.href = sample.url;
            a.target = '_blank';
            a.download = sample.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.downloadCurrent = () => window.downloadSample(null);

        // -----------------------------------------------------
        // 7. TABS LOGIC
        // -----------------------------------------------------
        window.switchTab = (tabName) => {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('page-title').innerText = tabName === 'browse' ? 'Browse Library' : 
                                                              tabName === 'likes' ? 'Liked Sounds' : 'My Downloads';
            
            loadSamples(); 
        };

        // Initial Load
        loadSamples();

    </script>
</body>
</html>
